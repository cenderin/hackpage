fs = require 'fs'
CoffeeScript = require 'coffee-script'
Compiler = require './compiler'
Parser = require './parser'


# An engine for rendering AsEjs templates.
class AsEco

  constructor: ->

    # The render function.
    @render_function = null


  # Compiles the given template into a render function.
  compile: (text) ->

    # Parse the template into segments.
    segments = Parser.parse text

    # Build the render function from the segments.
    compiler = new Compiler segments
    cs_source = compiler.compile()
    js_source = CoffeeScript.compile(cs_source, bare: yes)
    @render_function = eval js_source


  compile_file: (filename, done) ->
    fs.readFile filename, (err, data) =>
      throw new Error "AsEco.compile_file: Cannot read '#{filename}': #{err}" if err
      @compile data.toString()
      done()


  # HTML escapes the given string.
  escape: (text) ->
    new String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\x22/g, '&quot;')

  # Renders the given data into the precompiled template with the given name.
  render: (data, out_stream, done_cb) ->
    @render_function.call data, out_stream, done_cb, @escape



module.exports = AsEco
