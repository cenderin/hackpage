CoffeeScript = require 'coffee-script'
LazyLoadingRequestHandler = require './lazy_loading_request_handler.coffee'
fs = require 'fs'


# A request handler for clientside CoffeeScript files.
#
# Lazily converts the CoffeeScript source into JavaScript.
class CoffeeScriptRequestHandler extends LazyLoadingRequestHandler

  # The metadata that is output by default.
  get_default_metadata: ->
    {
      mime_type: 'text/javascript'
      response_code: 200
    }

  # Compile the CoffeeScript and return it as JavaScript.
  load_response: (done) ->
    fs.readFile @path, (err, coffee_source) =>
      throw "Error: Cannot read clientside CoffeeScript file '#{@path}'." if err
      done CoffeeScript.compile(coffee_source.toString())

module.exports = CoffeeScriptRequestHandler
