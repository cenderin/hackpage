fs = require 'fs'


# An abstract request handler that lazy-loads its response.
#
# Subclasses classes just need to implement the methods @load_response and @get_default_metadata.
class LazyLoadingRequestHandler

  constructor: (@path, @configuration) ->

    # The metadata that is output by default.
    @default_metadata = @get_default_metadata()

    # The renderer of the view.
    @process_request = @load_response_and_process_request


  # Placeholder function for lazy loading of the response.
  # Called on the first request.
  # Loads the response, and renders it to the client.
  load_response_and_process_request: (request, response, body, process_request_done) =>

    @load_response (@cached_response) =>
      @process_request = @process_request_directly
      @process_request request, response, body, process_request_done


  # Processes the given request.
  process_request_directly: (request, response, body, done) =>
    # TODO: set the response metadata here.
    response.end @cached_response
    done()


module.exports = LazyLoadingRequestHandler
