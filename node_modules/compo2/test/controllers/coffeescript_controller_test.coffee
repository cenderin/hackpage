[expect, sinon] = require('../test_helper')
CoffeeScriptController = require '../../src/controllers/coffeescript_controller.coffee'
fs = require 'fs'


describe 'CoffeeScriptController', ->

  describe 'controller_function_source', ->

    it 'returns the complete source code of the controller function', ->
      controller_file_content = '@foo = 1'
      result = CoffeeScriptController.controller_function_source controller_file_content
      expect(result).to.equal = """
                                ->
                                  @foo = 1
                                """


  describe 'execute', ->

    beforeEach ->
      @stub = sinon.stub fs, 'readFile'
      @controller = new CoffeeScriptController()

    afterEach ->
      @stub.restore()

    it 'executes the controller method', (done) ->
      @controller.method = (request, response) -> done()
      @controller.execute 'request', 'response', {}, ->

    it 'provides the request and response to the controller method', (done) ->
      @controller.method = ->
        expect(@request).to.equal 'request'
        expect(@response).to.equal 'response'
        done()
      @controller.execute 'request', 'response', {}, ->

    it 'returns the data provided by the controller method', (done) ->
      @controller.method = ->
        @foo = 'bar'
        @render()

      @controller.execute 'request', 'response', {}, (request_data) ->
        expect(request_data['foo']).to.equal 'bar'
        done()

